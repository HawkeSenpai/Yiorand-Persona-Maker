<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yiorand Persona Creator</title>
    <!-- Use Google Fonts for a fantasy feel -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Replace 'yiorand-icon.ico' with the actual path to your uploaded icon -->
    <link rel="icon" type="image/ico" href="yiorand-icon.ico"> 
    <style>
        /* BASE STYLES - High Fantasy Theme */
        :root {
            --color-dark-blue: #1c2a38;
            --color-gold: #c39f5f;
            --color-off-white: #e9e9e9;
            --color-text: #f0f0f0;
            --color-button: #507d86;
            --color-button-hover: #3d6a74;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-dark-blue);
            color: var(--color-text);
            padding: 20px;
        }
        .template-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            background: #253341; /* Slightly lighter than background for depth */
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--color-gold); /* Gold border for elegance */
        }
        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--color-gold);
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 25px;
            text-shadow: 0 0 8px rgba(195, 159, 95, 0.7); /* Subtle gold glow */
        }
        
        /* FORM ELEMENTS */
        .template-input {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #44596b;
            border-radius: 5px;
            font-size: 1em;
            background-color: #1c2a38;
            color: var(--color-text);
            box-sizing: border-box;
            min-height: 45px;
            transition: border-color 0.3s;
        }
        /* Style for the select dropdown */
        select.template-input {
            appearance: none; /* Remove default arrow in some browsers */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23c39f5f%22%20d%3D%22M287%20197.4l-118-118c-4.7-4.7-12.3-4.7-17%200l-118%20118c-4.7%204.7-4.7%2012.3%200%2017s12.3%204.7%2017%200l109.5-109.5c4.7-4.7%2012.3-4.7%2017%200l109.5%20109.5c4.7%204.7%2012.3%204.7%2017%200s4.7-12.3%200-17z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px;
            padding-right: 30px;
        }

        .template-input:focus {
            border-color: var(--color-gold);
            outline: none;
        }
        /* Style for the select dropdown when a required value is missing */
        .template-input:required:invalid {
            border-color: #cc4d4d; /* Red border for missing required field */
            box-shadow: 0 0 5px rgba(204, 77, 77, 0.5);
        }

        textarea.template-input {
            min-height: 100px;
            resize: vertical;
        }
        .template-label {
            display: block;
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 1.1em;
            color: var(--color-off-white);
        }
        .template-label span.optional {
            font-weight: 400;
            font-style: italic;
            color: #8c8c8c;
            margin-left: 10px;
            font-size: 0.9em;
        }
        .template-header {
            font-family: 'Playfair Display', serif;
            margin-top: 35px;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--color-gold);
            border-bottom: 2px solid var(--color-gold);
            padding-bottom: 8px;
            text-shadow: 0 0 5px rgba(195, 159, 95, 0.4);
        }

        /* HYPERLINKS */
        .template-label a {
            color: #79b0cc; /* A clickable blue */
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 400;
            margin-left: 10px;
        }
        .template-label a:hover {
            color: var(--color-gold);
            text-decoration: underline;
        }

        /* BUTTONS */
        #generateButton, #musicButton {
            background-color: var(--color-button);
            color: var(--color-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        #generateButton {
            padding: 18px 30px;
            font-size: 1.3em;
            display: block;
            width: 100%;
            margin-top: 40px;
        }
        /* Custom Music Button Styling */
        #musicButton {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #253341; /* Dark background */
            border: 1px solid var(--color-gold);
            color: var(--color-gold);
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        #musicButton:hover {
            background-color: #2f4052;
            transform: translateY(-1px);
        }
        #generateButton:hover {
            background-color: var(--color-button-hover);
            transform: translateY(-2px);
        }

        #errorMessage {
            color: #cc4d4d;
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        /* OUTPUT BOX */
        #outputBox {
            margin-top: 30px;
            padding: 25px;
            border: 2px solid var(--color-gold);
            background-color: #111a24; /* Very dark background for the generated sheet */
            white-space: pre-wrap;
            font-family: Consolas, monospace;
            font-size: 0.95em;
            border-radius: 8px;
            color: #f0f0f0;
            cursor: copy;
            min-height: 100px;
            display: none;
            box-shadow: 0 0 10px rgba(195, 159, 95, 0.5); /* Output glow */
        }
        /* CSS to ensure hidden field doesn't take space */
        .hidden-field {
            display: none; 
        }
    </style>
</head>
<body>

<div class="template-container">
    <h1>Yiorand Persona Creator</h1>

    <!-- CUSTOM AUDIO PLAYER -->
    <div style="text-align: center;">
        <audio id="bgMusic" loop>
            <!-- Change the source path to your uploaded audio file -->
            <source src="yiorand.rog.mp3" type="audio/mpeg">
        </audio>
        <button id="musicButton" onclick="toggleMusic()">
            <span>▶ Play Ambient Theme</span>
        </button>
    </div>

    <div class="template-header">Identity & Origin</div>
    
    <label class="template-label" for="charName">Name:</label>
    <input type="text" id="charName" class="template-input" placeholder="<Name>" required>
    
    <label class="template-label" for="alias">Alias: <span class="optional">(Optional)</span></label>
    <input type="text" id="alias" class="template-input" placeholder="<Known by / Nickname>">

    <label class="template-label" for="gender">Gender:</label>
    <input type="text" id="gender" class="template-input" placeholder="<Gender>" required>

    <!-- MADE OPTIONAL: age -->
    <label class="template-label" for="age">Age: <span class="optional">(Optional)</span></label>
    <input type="text" id="age" class="template-input" placeholder="<Age> (Note racial lifespan context)">

    <!-- **RACE DROPDOWN (SELECT) - PRIMARY FIELD** -->
    <label class="template-label" for="race">Race: <a href="https://janitorai.com/scripts/0b8a2b89-8b31-46fd-a224-0c17961a7dab" target="_blank">(View Racial Index)</a></label>
    <select id="race" class="template-input" required>
        <option value="">-- Select Race --</option>
        <option value="Human">Human</option>
        <option value="Elf">Elf</option>
        <option value="Drow">Drow</option>
        <option value="Dark Elf">Dark Elf</option>
        <option value="Dwarf">Dwarf</option>
        <option value="Gnome">Gnome</option>
        <option value="Halfling">Halfling</option>
        <option value="Demi-Human">Demi-Human (Beastfolk)</option>
        <option value="Kitsune">Kitsune</option>
        <option value="Orc">Orc</option>
        <option value="Dragonborn">Dragonborn</option>
        <option value="Tiefling">Tiefling</option>
        <option value="Aasimar">Aasimar</option>
        <option value="Vampire">Vampire</option>
        <option value="Goliath">Goliath</option>
        <option value="Centaur">Centaur</option>
        <option value="Minotaur">Minotaur</option>
        <option value="Goblin">Goblin</option>
    </select>
    
    <!-- **CONDITIONAL SUB-RACE INPUT** -->
    <div id="subRaceContainer" class="hidden-field">
        <label class="template-label" for="subRace">Sub-Race / Heritage:</label>
        <input type="text" id="subRace" class="template-input" placeholder="e.g., Lion, Wolf, or Orc Vampire" data-parent-race="">
    </div>

    <!-- **DEITY DROPDOWN (SELECT)** -->
    <label class="template-label" for="deity">Primary Deity: <a href="https://janitorai.com/scripts/be1b2039-17b2-4513-b648-58f9228676df" target="_blank">(View Pantheon)</a></label>
    <select id="deity" class="template-input" required>
        <option value="">-- Select Deity --</option>
        <option value="Atheist">Atheist</option>
        <option value="Vahnir, the Great Father">Vahnir, the Great Father</option>
        <option value="Lasmad, the Dragon God">Lasmad, the Dragon God</option>
        <option value="Osharia, the Shadow Dragon">Osharia, the Shadow Dragon</option>
        <option value="Mortanis, the Final Judge">Mortanis, the Final Judge</option>
        <option value="Aethyra, the Arcane Mother">Aethyra, the Arcane Mother</option>
        <option value="Thalros, the War God">Thalros, the War God</option>
        <option value="Valdren, the Lawkeeper">Valdren, the Lawkeeper</option>
        <option value="Zelvani, the Golden Tongue">Zelvani, the Golden Tongue</option>
        <option value="Velindra, the Heartbinder">Velindra, the Heartbinder</option>
        <option value="Mareus, Lord of Tides">Mareus, Lord of Tides</option>
        <option value="Demara, the Harvest Mother">Demara, the Harvest Mother</option>
        <option value="The Moon Spirits">The Moon Spirits</option>
        <option value="The First Dragon">The First Dragon</option>
    </select>

    <label class="template-label" for="occupation">Occupation:</label>
    <input type="text" id="occupation" class="template-input" placeholder="<Occupation>" required>
    
    <label class="template-label" for="title">Title: <span class="optional">(Optional)</span></label>
    <input type="text" id="title" class="template-input" placeholder="<E.g., Duke, Master of Whispers, The Black Hand>">

    <!-- **NATION DROPDOWN (SELECT)** -->
    <label class="template-label" for="nation">Nation: <a href="https://janitorai.com/scripts/936c3026-7959-4e2a-87af-c98bb9707301" target="_blank">(View Nations)</a></label>
    <select id="nation" class="template-input" required>
        <option value="">-- Select Nation/Region --</option>
        <option value="The Valendorn Empire">The Valendorn Empire</option>
        <option value="Xuihan">Xuihan</option>
        <option value="Aetherhaven">Aetherhaven</option>
        <option value="The Varanthia Empire - The Beastfolk Empire">The Varanthia Empire - The Beastfolk Empire</option>
        <option value="Faeloria">Faeloria</option>
        <option value="Xalithar">Xalithar</option>
        <option value="Thralgar">Thralgar</option>
        <option value="Eldrasil">Eldrasil</option>
        <option value="The Krilarene Dynasty">The Krilarene Dynasty</option>
        <option value="Dawnspire Kingdom - The Aasimar Realm">Dawnspire Kingdom - The Aasimar Realm</option>
        <option value="Slyvermire">Slyvermire</option>
        <option value="The Celdraeth Dynasty">The Celdraeth Dynasty</option>
        <option value="The Republic of Xeagon">The Republic of Xeagon</option>
        <option value="Snaunia">Snaunia</option>
        <option value="Nusmal">Nusmal</option>
        <option value="Umbrazar">Umbrazar</option>
        <option value="Solaceon">Solaceon</option>
        <option value="Nimblewood">Nimblewood</option>
        <option value="The Republic of Tribel">The Republic of Tribel</option>
        <option value="Brambledell">Brambledell</option>
        <option value="Orc Tribes of Sascia">Orc Tribes of Sascia</option>
        <option value="Human Tribes of Sascia">Human Tribes of Sascia</option>
        <option value="Goblin Tribes of Sascia">Goblin Tribes of Sascia</option>
        <option value="Goliath Tribes of Sascia">Goliath Tribes of Sascia</option>
        <option value="Dragonborn Tribes of Sascia">Dragonborn Tribes of Sascia</option>
        <option value="Centaur Tribe of Sascia">Centaur Tribe of Sascia</option>
        <option value="Minotaur Tribe of Sascia">Minotaur Tribe of Sascia</option>
    </select>

    <label class="template-label" for="description">Physical Description:</label>
    <textarea id="description" class="template-input" placeholder="<Concise physical description, including any racial features - scales, tails, horns, ears, etc.>" rows="3" required></textarea>


    <div class="template-header">Combat & Magic <a style="font-size: 0.5em; margin-left: 10px;" href="https://janitorai.com/scripts/e830d601-0767-41f7-b869-fd0a6e894dca" target="_blank">(View Magic System)</a></div>
    
    <label class="template-label" for="combatStyle">Combat Style:</label>
    <input type="text" id="combatStyle" class="template-input" placeholder="<Weapon/magic approach>" required>

    <!-- MADE OPTIONAL: Strengths -->
    <label class="template-label" for="strengths">Strengths: <span class="optional">(Optional)</span></label>
    <textarea id="strengths" class="template-input" placeholder="<3-5 keywords of combat/magic strengths>" rows="2"></textarea>

    <!-- MADE OPTIONAL: Weaknesses -->
    <label class="template-label" for="weaknesses">Weaknesses: <span class="optional">(Optional)</span></label>
    <textarea id="weaknesses" class="template-input" placeholder="<3-5 keywords of combat/magic weaknesses>" rows="2"></textarea>

    <!-- **ARDOUR CONNECTION DROPDOWN (SELECT) - UPDATED** -->
    <label class="template-label" for="ardourConnection">Ardour Connection:</label>
    <select id="ardourConnection" class="template-input" required>
        <option value="">-- Select Ardour Level --</option>
        <option value="Novice">Novice</option>
        <option value="Adept">Adept</option>
        <option value="Master">Master</option>
        <option value="Archmage">Archmage</option>
        <option value="Ardour-Weak">Ardour-Weak</option>
        <option value="Ardour-Absent">Ardour-Absent</option>
    </select>

    <div id="magic-details">
        <label class="template-label" for="knownPrinciples">Known Principles: <span class="optional">(Optional)</span></label>
        <textarea id="knownPrinciples" class="template-input" placeholder="<List of known magic principles with mastery level>" rows="2"></textarea>

        <!-- **CASTING STYLE DROPDOWN (SELECT)** -->
        <label class="template-label" for="castingStyle">Casting Style:</label>
        <select id="castingStyle" class="template-input" required>
            <option value="">-- Select Casting Style --</option>
            <option value="Academic">Academic</option>
            <option value="Primal">Primal</option>
            <option value="Instinctive">Instinctive</option>
            <option value="Survival">Survival</option>
            <option value="Scientific">Scientific</option>
        </select>

        <!-- **STRAIN TOLERANCE DROPDOWN (SELECT)** -->
        <label class="template-label" for="strainTolerance">Strain Tolerance:</label>
        <select id="strainTolerance" class="template-input" required>
            <option value="">-- Select Strain Tolerance --</option>
            <option value="Low">Low</option>
            <option value="Moderate">Moderate</option>
            <option value="High">High</option>
        </select>

        <label class="template-label" for="limitations">Limitations: <span class="optional">(Optional)</span></label>
        <textarea id="limitations" class="template-input" placeholder="<Racial or personal restrictions>" rows="2"></textarea>
    </div>


    <div class="template-header">Backstory</div>
    
    <label class="template-label" for="backstory">Backstory: <span class="optional">(Optional)</span></label>
    <textarea id="backstory" class="template-input" rows="4" placeholder="<Key chronological events, crucial past relationships, how culture influenced them, etc. (Keep this section for your own detailed notes)>"></textarea>

    <label class="template-label" for="faction">Faction Affiliations: <span class="optional">(Optional)</span> <a href="https://janitorai.com/scripts/8a563b4e-aebb-40fb-80a6-0e84452158b5" target="_blank">(View Factions)</a></label>
    <textarea id="faction" class="template-input" placeholder="<Any connection to major groups: Arcane Assembly, Covenant of Scales, etc.>" rows="2"></textarea>

    <label class="template-label" for="notes">Notes/Secrets: <span class="optional">(Optional)</span></label>
    <textarea id="notes" class="template-input" placeholder="<Anything that doesn't fit other sections, important plot hooks or secrets>" rows="2"></textarea>


    <button id="generateButton">Seal the Codex</button>

    <div id="errorMessage"></div>

    <!-- OUTPUT BOX - Click to Copy -->
    <div id="outputBox">
        Click the button above to generate your persona sheet. Then, click here to copy the final text!
    </div>
</div>

<script>
    // Helper function to get value, returns an empty string if blank
    const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value.trim() : '';
    
    // Core template line builder
    const buildLine = (label, value) => {
        // If the value is empty, return an empty string (conditional logic)
        if (!value) return ''; 
        // Otherwise, return the formatted line with a newline character
        return `${label}: ${value}\n`;
    };
    
    // --- CUSTOM MUSIC TOGGLE ---
    function toggleMusic() {
        const music = document.getElementById('bgMusic');
        const btn = document.getElementById('musicButton');
        
        if (music.paused) {
            music.play();
            btn.innerHTML = '<span>❚❚ Pause Ambient Theme</span>';
            btn.style.borderColor = '#c39f5f';
            btn.style.backgroundColor = '#354a5f';
        } else {
            music.pause();
            btn.innerHTML = '<span>▶ Play Ambient Theme</span>';
            btn.style.backgroundColor = '#253341';
        }
    }

    // --- DYNAMIC SUB-RACE LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        const raceSelect = document.getElementById('race');
        const subRaceContainer = document.getElementById('subRaceContainer');
        const subRaceInput = document.getElementById('subRace');

        const ardourSelect = document.getElementById('ardourConnection');
        const magicDetails = document.getElementById('magic-details');
        const castingStyleSelect = document.getElementById('castingStyle');
        const strainToleranceSelect = document.getElementById('strainTolerance');

        const subRaceHandler = () => {
            const selectedRace = raceSelect.value;
            // Races that require a sub-race detail
            const requiresSubRace = ["Vampire", "Demi-Human"]; 

            if (requiresSubRace.includes(selectedRace)) {
                subRaceContainer.style.display = 'block';
                subRaceInput.setAttribute('required', 'required');
                
                // Update placeholder/label based on race
                const label = subRaceContainer.querySelector('label');
                if (selectedRace === "Vampire") {
                    label.innerText = "Vampiric Heritage (Required):";
                    subRaceInput.placeholder = "e.g., Human Vampire, Orc Vampire, etc.";
                } else if (selectedRace === "Demi-Human") {
                    label.innerText = "Beastfolk Type (Required):";
                    subRaceInput.placeholder = "e.g., Lion, Wolf, Bear, Fox, etc.";
                }
            } else {
                subRaceContainer.style.display = 'none';
                subRaceInput.removeAttribute('required');
                subRaceInput.value = ''; // Clear value if hidden
            }
        };

        const ardourHandler = () => {
            const ardourLevel = ardourSelect.value;
            if (ardourLevel === "Ardour-Absent") {
                magicDetails.style.display = 'none';
                castingStyleSelect.removeAttribute('required');
                strainToleranceSelect.removeAttribute('required');
                // Optional: Clear values for hidden fields to prevent accidental output
                castingStyleSelect.value = '';
                strainToleranceSelect.value = '';
            } else {
                magicDetails.style.display = 'block';
                // Only re-add 'required' if a non-placeholder value is selected
                if (ardourLevel !== "") {
                    castingStyleSelect.setAttribute('required', 'required');
                    strainToleranceSelect.setAttribute('required', 'required');
                }
            }
        };

        // Attach handlers to change events
        raceSelect.addEventListener('change', subRaceHandler);
        ardourSelect.addEventListener('change', ardourHandler);

        // Initial run to set up based on defaults
        subRaceHandler();
        ardourHandler();
    });

    // Array of required field IDs and their descriptive names for validation
    const REQUIRED_FIELDS = [
        { id: 'charName', label: 'Name' },
        { id: 'gender', label: 'Gender' },
        { id: 'race', label: 'Race' },
        { id: 'deity', label: 'Primary Deity' },
        { id: 'occupation', label: 'Occupation' },
        { id: 'nation', label: 'Nation' },
        { id: 'description', label: 'Physical Description' },
        { id: 'combatStyle', label: 'Combat Style' },
        { id: 'ardourConnection', label: 'Ardour Connection' },
    ];

    document.getElementById('generateButton').onclick = function() {
        const outputBox = document.getElementById('outputBox');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        errorMessage.innerText = '';
        outputBox.style.display = 'none';

        const ardourLevel = getVal('ardourConnection');
        const selectedRace = getVal('race');
        let missingFields = [];

        // --- VALIDATION CHECK ---
        for (const field of REQUIRED_FIELDS) {
            const inputElement = document.getElementById(field.id);
            const value = inputElement.value.trim();

            if (!value || value.startsWith('-- Select')) {
                missingFields.push(field.label);
            }
        }
        
        // Conditional Sub-Race Validation
        const subRaceInput = document.getElementById('subRace');
        if (subRaceInput.hasAttribute('required') && !getVal('subRace')) {
             missingFields.push(subRaceInput.previousElementSibling.innerText.replace(':', '').replace('(Required)', '').trim());
        }


        // Conditional Magic Detail Validation (if not Ardour-Absent)
        if (ardourLevel !== "Ardour-Absent") {
            const castingStyleElement = document.getElementById('castingStyle');
            const strainToleranceElement = document.getElementById('strainTolerance');

            if (!castingStyleElement.value || castingStyleElement.value.startsWith('-- Select')) {
                missingFields.push('Casting Style');
            }
            if (!strainToleranceElement.value || strainToleranceElement.value.startsWith('-- Select')) {
                missingFields.push('Strain Tolerance');
            }
        }

        if (missingFields.length > 0) {
            errorMessage.innerText = `Please fill out all required fields before sealing the Codex: ${missingFields.join(', ')}.`;
            errorMessage.style.display = 'block';
            return; // STOP execution if required fields are missing
        }

        // Fetch all values, including conditional subRace
        const subRaceValue = getVal('subRace');
        
        const values = {
            charName: getVal('charName'),
            alias: getVal('alias'), 
            gender: getVal('gender'),
            age: getVal('age'),
            race: selectedRace + (subRaceValue ? ` (${subRaceValue})` : ''), // COMBINE RACE + SUBRACE
            deity: getVal('deity'), 
            occupation: getVal('occupation'),
            title: getVal('title'), 
            nation: getVal('nation'), 
            description: getVal('description'), 

            combatStyle: getVal('combatStyle'), 
            strengths: getVal('strengths'),
            weaknesses: getVal('weaknesses'),
            ardourConnection: ardourLevel, 
            knownPrinciples: getVal('knownPrinciples'),
            castingStyle: getVal('castingStyle'), 
            strainTolerance: getVal('strainTolerance'), 
            limitations: getVal('limitations'),
            
            backstory: getVal('backstory'),
            faction: getVal('faction'),
            notes: getVal('notes')
        };
        
        // --- TEMPLATE CONSTRUCTION (Order is fixed) ---
        let generatedText = '';
        
        // --- IDENTITY & ORIGIN ---
        generatedText += buildLine("Name", values.charName);
        generatedText += buildLine("Alias", values.alias); 
        generatedText += buildLine("Gender", values.gender);
        generatedText += buildLine("Age", values.age); 
        generatedText += buildLine("Race", values.race); // COMBINED OUTPUT HERE
        generatedText += buildLine("Primary Deity", values.deity); 
        generatedText += buildLine("Occupation", values.occupation);
        generatedText += buildLine("Title", values.title); 
        generatedText += buildLine("Nation", values.nation);
        
        generatedText += "\nAPPEARANCE\n";
        generatedText += buildLine("Physical Description", values.description);

        // --- BACKSTORY ---
        if (values.backstory) {
            generatedText += "\nBACKSTORY (OPTIONAL)\n";
            generatedText += values.backstory + "\n";
        }
        
        // --- COMBAT & MAGIC (Unified Section) ---
        generatedText += "\nCOMBAT & MAGIC\n";
        generatedText += buildLine("Combat Style", values.combatStyle);
        generatedText += buildLine("Strengths", values.strengths); 
        generatedText += buildLine("Weaknesses", values.weaknesses); 
        generatedText += buildLine("Ardour Connection", values.ardourConnection);
        
        // --- CONDITIONAL MAGIC DETAILS ---
        if (values.ardourConnection !== "Ardour-Absent") {
            generatedText += buildLine("Known Principles", values.knownPrinciples); 
            generatedText += buildLine("Casting Style", values.castingStyle); 
            generatedText += buildLine("Strain Tolerance", values.strainTolerance); 
            generatedText += buildLine("Limitations", values.limitations); 
        }

        // --- FACTION & NOTES ---
        if (values.faction) {
            generatedText += "\nFACTION AFFILIATIONS (OPTIONAL)\n";
            generatedText += buildLine("Affiliations", values.faction);
        }

        if (values.notes) {
            generatedText += "\nNOTES (OPTIONAL)\n";
            generatedText += buildLine("Details", values.notes);
        }

        // Clean up empty lines and trim whitespace
        generatedText = generatedText.replace(/\n\n+/g, '\n\n').trim();

        // Update the output box
        outputBox.innerText = generatedText;
        outputBox.style.display = 'block'; 
    };

    // Simple function to copy the text on click (remains the same)
    document.getElementById('outputBox').onclick = function() {
        const textToCopy = this.innerText;
        if (!textToCopy || textToCopy.includes("Click the button above")) return;

        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = this.innerText;
            this.innerText = "COPIED TO CLIPBOARD! Click again to see the sheet.";
            setTimeout(() => { this.innerText = originalText; }, 1500);
        }).catch(err => {
            console.error('Could not copy text: ', err);
            // Fallback for environments where clipboard API is restricted
            prompt("Copy failed. Please copy the text below:", textToCopy);
        });
    };
</script>

</body>
</html>
